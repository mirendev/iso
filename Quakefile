

task build {
  @echo "Getting version information..."
  commit=$(git rev-parse HEAD)
  ldflags="-X main.commit=$commit"

  @echo "Creating build directory..."
  mkdir -p build

  @echo "Building Linux iso binaries..."
  GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -tags linux_build -ldflags "$ldflags" -o build/iso-linux-amd64 ./cmd/iso
  GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -tags linux_build -ldflags "$ldflags" -o build/iso-linux-arm64 ./cmd/iso

  @echo "Compressing Linux binaries..."
  gzip -9 -f build/iso-linux-amd64
  gzip -9 -f build/iso-linux-arm64

  @echo "Zeroing out current architecture binary (will use os.Executable)..."
  if [ "$(go env GOOS)" = "linux" ]; then
  |   : | gzip > build/iso-linux-$(go env GOARCH).gz;
  | fi

  @echo "Building iso..."
  mkdir -p bin
  CGO_ENABLED=0 go build -tags embed_binaries -ldflags "$ldflags" -o bin/iso ./cmd/iso
}

task install => build {
  # Install iso binary to user's bin directory
  @echo "Installing iso to ~/bin/iso..."
  mkdir -p ~/bin
  install -m 755 bin/iso ~/bin/iso
  @echo "Installed successfully to ~/bin/iso"
}
